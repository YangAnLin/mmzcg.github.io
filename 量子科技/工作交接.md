# 总体

![: 0 ](https://raw.githubusercontent.com/YangAnLin/images/master/20200908153625.png)

我接手之后的改动:

1. 内侧,外侧的前端代码,都是独立部署,用Nginx反代,线上还没有单独部署,这次上线可以独立部署了,已经把内侧外侧分支的前端代码删掉了
2. 增加`xxl-job`,只有ES的补单在用
3. 增加了ES集群
   1. 所有的查询代码都在`search-service`
      * 通常就是业主系统在用
   2. 大部分的插入代码也都是`search-service`
   3. 剩余的插入数据的别的服务也有
      * 拉取第三方的注单,写入数据的时候也会写入ES
      * 天天游戏的写分也,写入数据的时候也会写入ES
   4. * ![image-20200910181431190](https://raw.githubusercontent.com/YangAnLin/images/master/20200910181433.png)	
      * 用在天天游戏和第三方游戏
      * 还有COCOS的负盈利的查询
   5. 线上ES要缺少数据,就找运维执行``init3`的请求
4. 增加`gateway`网关服务,使用这个的原因,是因为有两台``business`服务,服务端又只能连接一台
5. 这次搭建内侧环境,把``DB层``的``info文件``日志的等级调整到`trace`,info文件里的信息,就包含info,debug,trace,error的信息(trace打印的是mapper层的数据查询详细),`error`文件,就只有error信息
6. 不是DB层的日志,就只有INFO和ERROR
7. 删除了LOGSTASH的包和熔断的包,还有测试的包,这些在代码上都没有用到
8. 使用Mybatis-Plus,目前用处最大的还是分页,包括单表的分页查询,和把视图当做单表查询

# 分支情况

| key          | value                                                       |
| ------------ | ----------------------------------------------------------- |
| `prod`       | 线上,sql server                                             |
| `prerelease` | 外侧,mysql                                                  |
| `test`       | 内侧,mysql                                                  |
| `develop`    | 开发,看到的代码,已经把develop分支删掉了                     |
| `baoxue`     | 使用线上sql server的代码和暴雪自己的配置,给暴雪搭建的测试服 |

还有些问题:

* 有的服务并不是按照表格中的分支规范,比如prod02,prod_proc 这种,在部署的时候要留意,我看到的没有用的分支,尽量都删掉了
* 有的服务,只有一个分支
  * 具体情况要看各环境的jenkins打包用的是哪个分支的代码
* 有的服务,甚至是在线上跑的也没有指定用prod的代码
  * 具体情况要看各环境的jenkins打包用的是哪个分支的代码
* 在使用启动命令`java -jar xxx.jar --spring.profiles.active= xxx`这里的时候,应该是指定哪个环境的,通常应该使用的是分支的名字,但是在线上跑的项目,指定的环境也不统一规范
* 在这次搭建内侧和外侧的环境,都尽量规范了分支

# 迁移数据库

1. `data-server`和`business`的代码,都是在开始做迁移数据库的时候重新从`prod`分支上拉的代码
2. 其余的服务我也是重新从prod拉的代码,上线的时候,基本上差异都不会大
3. 上线解决冲突的时候,尽可能的使用外侧的代码,如果业务代码冲突,尽可能的使用线上的代码,体育的要看情况
4. 等到要上线之前,先把``tset--->prerelease`,`prod---->prerelease`(就是把内侧和线上的代码合并,放到外侧分支),合并代码时,解决冲突,内侧和线上有业务冲突的代码,做好标记,上线的时候会用上,到上线的时候,就直接把`prerelease`的代码替换到prod上,解决冲突的时候,照着之前上外侧的标记解决冲突

# 现有的后端服务

* base-server
  * admin(`监控`)
    * config-server(`配置中心`)
  * eureka-server(`注册中心`)
  * gateway-server(`网关`)
  * xxl-job-admin(`定时任务`)
* data-server
  * accounts-service
  * agent-service
  * fund-service(`本用来做资金的服务`)
  * lottery-service(`彩票`)
  * nativeweb-service
  * platform-service
  * platformManager-service
  * record-service
  * search-service(`ES搜索服务`)
  * sports-service(`体育`)
  * treasure-service
* business-service(`存过改代码`)
* API
  * access2game
  * channelGame
* Font
  * agent(`业主`)
  * agent_api(`业主API`)
  * control
  * manager
  * mobile-server
  * sport(`体育`)
* 其它没有使用jenkins
  * file(`文件服务,git仓库里有`)
  * home-centre 和 jump-server(`推广,域名三级跳`)

# Jacob跟我对接的

## 游戏涉及到的表

```sql
游戏：
RYPlatformDB.dbo.MobileKindItem --天天游戏总表
RYPlatformDB.dbo.ThirdKindItem --第三方游戏表
RYPlatformDB.dbo.Agent_MobileKindConfig --业主对应的天天游戏表
RYPlatformDB.dbo.ThirdKindConfig  --业主对应的第三方游戏表
RYPlatformDB.dbo.GameRoomInfo --天天的房间记录表 这是服务端来控制的
RYPlatformDB.dbo.Agent_GameOpen --业主对应的房间  现在 agent=0 空所有
```

## 游戏记录

第三方的游戏记录会存两份 
1份详细的记录在``mongodb`
1份需要统计的记录在`T_ChannelGame_UserDayBet`

## 写分

天天游戏详情服务端写分成功后 ``/mobileInterface/addGameRecord`

对天天的洗码 活动 体现打码量 游戏记录入es 是服务端写分成功后回调`` /writeGame/callback`

对第三方的洗码 活动 体现打码量 游戏记录入es 是拉取玩注单会调用相应的接口

## 洗码

```sql
T_CleanConfig     ---洗码配置表
T_CleanConfig_Details --洗码配置详情表
T_CleanShip_Bet    --待洗码的记录表
T_CleanShip_Date   --自助洗码时间
T_CleanShip_Details --每次洗码详情表(保留3个月的数据,其余数据在history)
T_CleanShip_Details_History 
T_CleanShip_Record  --每次洗码记录表(保留3个月的数据,其余数据在history)
T_CleanShip_Record_History

-- 所涉及到的业务搜索cleanship类都在里面
```

## 用户福利活动

```sql
用户福利活动：
userinfo_welfare_apply  --申请记录表
userinfo_welfare_config -- 配置表
userInfo_welfare_lock   -- 记录是否锁定
userinfo_welfare_noaging --用户免打扰记录时间
userinfo_welfare_record --每次修改配置表的记录
userinfo_welfare_trigger --用户触发记录时间

-- 所涉及到的业务搜索userinfo类都在里面
```

## API文档

```curl
http://tw-git.wm732.com/jacob/DOC 都在里面
```

## 其余的表

```sql
------------ RYAccountsDB -------------------
TABLE
[RYAccountsDB].[AccBankVerifyInfo]              银行卡审核功能
[RYAccountsDB].[AccountsInfo]                      账号表
[RYAccountsDB].[AccountsLevel]                     拆分账号表（记录玩家VIP等级，积分，用户层级）
[RYAccountsDB].[AccountsLogin]                    记录玩家登录信息
[RYAccountsDB].[AccountsQmRatio]               全民代理业务从accountsinfo中拆分出来（全民代理表）
[RYAccountsDB].[AccountsSignin]                   记录玩家连续登录日期
[RYAccountsDB].[AndroidConfigure]               游戏机器人配置表
[RYAccountsDB].[AccountsTask]                     记录玩家任务记录表
[RYAccountsDB].[AndroidLockInfo]                 记录机器人当前游戏锁定
[RYAccountsDB].[ApplyOrder]                         玩家申请提现记录
[RYAccountsDB].[ApplyOrderRemark]             后台操作打款备注
[RYAccountsDB].[BlackWhiteList]                    玩家黑白名单记录
[RYAccountsDB].[ConfineAddress]                  玩家登录IP限制记录表
[RYAccountsDB].[ConfineMachine]                 玩家机器码限制记录表
[RYAccountsDB].[FirstTeamRechargesData]    记录玩家首充时间
[RYAccountsDB].[GameIdentifier]                   分配玩家GameID
[RYAccountsDB].[IndividualDatum]                 记录玩家绑定银行信息
[RYAccountsDB].[IPAddress]                           IP地址记录表
[RYAccountsDB].[SystemGrantCount]             登录IP与登录机器码，以及赠送金币
[RYAccountsDB].[SystemMachineGrantCount] 登录IP与登录机器码，以及赠送金币（这两张表记录相同的东西，其实是没有必要的）
[RYAccountsDB].[SystemStatusInfo]                系统功能键值对
[RYAccountsDB].[SystemStreamInfo]               记录玩家登录次数以及登录方式
[RYAccountsDB].[T_Agent_News]                    系统公告（游戏展示走马灯）
[RYAccountsDB].[T_ChannelGame_UserDayBet] 所有游戏的下注记录
[RYAccountsDB].[T_Mails]                               邮箱
[RYAccountsDB].[T_SendTemplate]                 邮件发送模板
[RYAccountsDB].[T_UserFill]                            玩家日充值总额（目前这张表依旧有写数据，但是展示上没有取这个表） 
[RYAccountsDB].[T_UserInChannelGame]        玩家在第三方游戏游戏名称，分数
[RYAccountsDB].[Table_User_TMP]                  分配玩家UserID
PROC
[RYAccountsDB].[CreateGameID]                    分配玩家GameID
[RYAccountsDB].[GetRedEnvelope]                  获取红包奖励
[RYAccountsDB].[GSP_GP_ModifyLogonPassword]  修改密码
[RYAccountsDB].[GSP_GP_ModifyNickName]    修改昵称
[RYAccountsDB].[GSP_MB_RegisterAccounts]    账号注册
[RYAccountsDB].[GSP_MB_EfficacyOtherPlatform] 微信注册
[RYAccountsDB].[GSP_MB_EfficacyLogonVisitor]  游客登录
[RYAccountsDB].[GSP_MB_EfficacyAccounts]     账号登录
[RYAccountsDB].[P_Acc_Activity]                        活动红包
[RYAccountsDB].[P_Acc_LoginActivity]               登录红包
[RYAccountsDB].[P_Acc_PLayerBindBank]          玩家绑定银行卡(目前应该是用程序实现这个功能)
[RYAccountsDB].[P_Acc_PlayerDraw]                 玩家申请提现
[RYAccountsDB].[P_Acc_PlayerDrawRefused]     后台提现审核
[RYAccountsDB].[P_Acc_RedEnvelope]               领取红包
[RYAccountsDB].[P_Acc_RegGrant]                    绑定手机赠送
[RYAccountsDB].[PROC_CG_TaskForward]         视讯任务推进
[RYAccountsDB].[PROC_CG_WriteGameScore]	 第三方写分存储
[RYAccountsDB].[P_VisitorBind] 绑定手机(已作废) 改为了调用/mobileInterface/updateUserContactInfo
------------ RYAgentDB -------------------
TABLE
[Agent_RRConfig]                         英雄榜配置表（目前这个功能已经完成，未开放）
[Agent_SystemStatusInfo]             业主系统系统配置表
[BankCardType]                            业主支持玩家绑定银行卡类型
[CloudShieldConfiguration]          云盾配置
[Qm_DayPromotionDetail]            全民代理每日推广详情
[Qm_LiquidationRewardRecord]    全民代理提现记录
[Qm_RewardRecord]                     全民代理返佣记录
[Qm_UserReward]                        全民代理所有返佣金额以及未领取金额
[RecordSingleRedEnvelope]           红包领取记录表
[RedEnvelope]                              红包配置表
[SaveLastTimeActivityId]               保存最近一次红包雨活动ID
[RedEnvelopeConditionType]       红包类型配置表
[DayRedEnvelopLock]                   记录红包雨发出个数（记录表）
[T_Acc_Agent]                              业主表（登录代理管理系统)
[T_Agent_PagePermission]           接口权限基本信息
[T_Agent_PageRolePermission]      业主子帐号角色权限表（用户组+权限ID）
[T_Agent_Permission和T_Agent_RolePermission]   已弃用

[T_Agent_RoleGroup.GroupID=T_Agent_Role.RoleID 用户组关系

PROC
[P_Acc_AddAgent]                        新增代理
[NET_PM_WriteRevnueRecord]     老版代理抽水
[NET_QM_WriteRevnueRecord]     至尊全民代理抽水
[P_Acc_AddAgentNew]                 添加下级代理
[ZZ_QM_MyPlayer]                       全民代理我的玩家
[ZZ_QM_WriteRevnueRecord]       全民代理
[P_ReceiveRedEnvelopeRain]         领取红包雨

------------ RYNativeWebDB-------------------
[RYNativeWebDB].[Activity]                               活动配置
[RYNativeWebDB].[News]                                  新闻

------------ RYPlatformDB -------------------
[Agent_GameOpen]                  业主游戏房间开启配置
[BlackJackRobotConfig]            21点配置
[ChargeBuffConfig]                  充值增益配置
[CleanChipsConfig]                  洗码比例配置  
[CleanChipsDetail]                    洗码投注记录 
[CleanChipsRecord]                  洗码记录
[FruitSlots_Pool]                       水果拉霸奖池
[GameConfiguration]               游戏库存，杀率配置
[GameFeedback]                      游戏内反馈信息记录
[GameGameItem]                     服务端记录的游戏房间信息
[GameRoomInfo]                     游戏房间信息
[GoldenFlowerConfig]              诈金花配置
[HundredBanker]                     百人游戏配置
[HundredsConfig]                    百人游戏筹码，下注区域配置
[Luckywheelconfig]                  幸运转盘配置
[MobileKindItem]                     web端记录游戏房间开启信息
[RedBlackConfig]                      红黑配置
[RedEnvelopeDeminingConfig] 红包扫雷配置
[ShuiHuZhuanConfig]               水浒传
[SigninConfig]                          签到配置
[Whitelist_Config]                     中发白配置
[VIP_ReceiveInfo]                      VIP奖励领取记录
[VIP_RankReceiveInfo]             VIP等级领取记录
[VIP_IntegrealConfig]                VIP奖励配置
[VIP_IntegralConversionConfig] 打码充值兑换vip积分配置  
1: 视讯
2：电子
3：棋牌
4：捕鱼
5：体育
6：彩票
PROC
[GSP_GR_CheckInDone]                                    签到
[GSP_GR_VIPRankRewardInfo]                          领取vip等级奖励
[GSP_GR_VIPRewardReceiveInfo]                      领取vip 日常奖励
[SelfHelp_CleanBet]                                          自动洗码 
------------ RYPlatformManagerDB------------------- 
目前只有manger项目的角色信息，权限信息存在这个库

------------ RYRecordDB------------------------------
[RYRecordDB].[RecordTask]                              领取任务奖励记录
[RYRecordDB].[RecordSignin]                           领取签到记录 
[RYRecordDB].[RecordGrantTreasure]               赠送金币记录
------------ RYTreasureDB -------------------
[Active_Limit]                           给玩家清除打码量/增加打码量
[Company_Pay]                        公司支付配置表
[Company_Pay_Record]            公司支付记录表
[FirstChargeConfig]                  每日首存赠送配置表
[GameScoreInfo]                      用户金币记录
[GameScoreLocker]                  用户当前在天天平台玩游戏会记录这张表
[GlobalShareInfo]                     充值类型表
[LuckyOrderConfig]                  幸运注单配置
[LuckyOrderConfigItem]           幸运注单奖励配置
[LuckyOrderInfo]                      幸运注单记录
[LuckyTurntableControl]           幸运转盘配置
[OnLineOrder]                          充值记录表
[RecordDrawInfo]                     天天游戏记录
[RecordDrawScore]                   天天游戏打码记录
[RecordPresentInfo]                  玩家金币变化记录（账变记录）   
[RecordType]                            金币变化类型
[T_PayInfo]                               第三方支付支付配置表
[T_PayLineConfig]                     检测当前支付线路
[T_PayOwnerInfo]                     支付后台key值配置
[T_PayQudaoInfo]                     第三方支付渠道信息
[T_QudaoLimit]                         渠道限额
[T_UserLevel]                             用户层级配置表
[T_UserLevelType]                      用户层级字典
[T_UserLevelInfo]                       用户层级配置配置信息
[T_UserLevelChannel]                用户层级与功能相对应得关联表
[TransactionType]                      个人中心下拉框类型
[ZZ_Qm_ChargeScore]               全民代理团队充值记录
[ZZ_Qm_DayUserAbcScore]       全民代理团队打码记录
[Yeb_ProfitDayQueue]               
[Yeb_ProfitDetails]                    记录余额宝收益

PROC
[FirstCharge]                                                      每日首充                                         
[GSP_GR_EfficacyMobile]                                    玩家登录游戏服 
[GSP_GR_EfficacyUserID]                                    机器人登录游戏服
[GSP_GR_KickOut]                                              踢人
[GSP_GR_UserSaveScore]                                    金币存入余额宝  
[GSP_GR_UserTakeScore]                                   金币从余额宝取出
[GSP_GR_WriteGameScore]                                写分  
[NET_PM_AgentDividend]                                   代理分红    
[NET_PM_GiftGold]                                            批量导入赠送金币
[NET_PM_GrantTreasure]                                   后台赠送金币1是金币2是房卡 3是银行 4,测试金币,5活动金币  6公司充值反还  7银商充值反还   8扣除金币，9人工存入返,10。扣除银行金币,11 银行提现回退
[NET_PM_Manualdeposit]                                  人工存入返利与公司支付返利
[NET_PM_SilverPayScore]                                   银商支付
[NET_PW_ApplyOnLineOrder]                             公司支付申请订单
[NET_PW_CompanyPayScore]                             公司支付后台审核
[NET_PW_FilledOnLine]                                      充值回调
[UserLevel_UpGrade]                                          用户层级升级
[Proc_Yeb]                                                         余额宝收益计算 
[PROC_CG_updateUserScore]                             视讯平台资金切换
[PROC_CG_TaskForward]                                   第三方游戏任务推进
```

# 后续优化

1. 单表查询都使用``mybatis-plus`

2. 服务之间的调用使用统一的对象返回,并且在调用层判断是否有异常抛出来

3. 增加公共类模块,封装`swagger配置`,`工具类`,`分页实体类`....

4. 后端和前端的接口,以及服务和服务之间的调用,去掉多余的没有使用的字段

5. 后端的代码都加上数据校验

6. 看数据量情况,可考虑加`TIDB`数据库,专门用来做查询

   