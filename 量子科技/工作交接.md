# 总体

![: 0 ](https://raw.githubusercontent.com/YangAnLin/images/master/20200908153625.png)

我接手之后的改动:

1. 内侧,外侧的前端代码,都是独立部署,用Nginx反代,线上还没有单独部署,这次上线可以独立部署了,已经把内侧外侧分支的前端代码删掉了
2. 增加`xxl-job`,只有ES的补单在用
3. 增加了ES集群
   1. 所有的查询代码都在`search-service`
      * 通常就是业主系统在用
   2. 大部分的插入代码也都是`search-service`
   3. 剩余的插入数据的别的服务也有
      * 拉取第三方的注单,写入数据的时候也会写入ES
      * 天天游戏的写分也,写入数据的时候也会写入ES
   4. * ![image-20200910181431190](https://raw.githubusercontent.com/YangAnLin/images/master/20200910181433.png)	
      * 用在天天游戏和第三方游戏
      * 还有COCOS的负盈利的查询
   5. 线上ES要缺少数据,就找运维执行``init3`的请求
4. 增加`gateway`网关服务,使用这个的原因,是因为有两台``business`服务,服务端又只能连接一台
5. 这次搭建内侧环境,把``DB层``的``info文件``日志的等级调整到`trace`,info文件里的信息,就包含info,debug,trace,error的信息(trace打印的是mapper层的数据查询详细),`error`文件,就只有error信息
6. 不是DB层的日志,就只有INFO和ERROR
7. 删除了LOGSTASH的包和熔断的包,还有测试的包,这些在代码上都没有用到
8. 使用Mybatis-Plus,目前用处最大的还是分页,包括单表的分页查询,和把视图当做单表查询

# 分支情况

| key          | value                                                       |
| ------------ | ----------------------------------------------------------- |
| `prod`       | 线上,sql server                                             |
| `prerelease` | 外侧,mysql                                                  |
| `test`       | 内侧,mysql                                                  |
| `develop`    | 开发,看到的代码,已经把develop分支删掉了                     |
| `baoxue`     | 使用线上sql server的代码和暴雪自己的配置,给暴雪搭建的测试服 |

还有些问题:

* 有的服务并不是按照表格中的分支规范,比如prod02,prod_proc 这种,在部署的时候要留意,我看到的没有用的分支,尽量都删掉了
* 有的服务,只有一个分支
  * 具体情况要看各环境的jenkins打包用的是哪个分支的代码
* 有的服务,甚至是在线上跑的也没有指定用prod的代码
  * 具体情况要看各环境的jenkins打包用的是哪个分支的代码
* 在使用启动命令`java -jar xxx.jar --spring.profiles.active= xxx`这里的时候,应该是指定哪个环境的,通常应该使用的是分支的名字,但是在线上跑的项目,指定的环境也不统一规范
* 在这次搭建内侧和外侧的环境,都尽量规范了分支

# 迁移数据库

1. `data-server`和`business`的代码,都是在开始做迁移数据库的时候重新从`prod`分支上拉的代码
2. 其余的服务我也是重新从prod拉的代码,上线的时候,基本上差异都不会大
3. 上线解决冲突的时候,尽可能的使用外侧的代码,如果业务代码冲突,尽可能的使用线上的代码,体育的要看情况
4. 等到要上线之前,先把``tset--->prerelease`,`prod---->prerelease`(就是把内侧和线上的代码合并,放到外侧分支),合并代码时,解决冲突,内侧和线上有业务冲突的代码,做好标记,上线的时候会用上,到上线的时候,就直接把`prerelease`的代码替换到prod上,解决冲突的时候,照着之前上外侧的标记解决冲突

# 现有的后端服务

* base-server
  * admin(`监控`)
    * config-server(`配置中心`)
  * eureka-server(`注册中心`)
  * gateway-server(`网关`)
  * xxl-job-admin(`定时任务`)
* data-server
  * accounts-service
  * agent-service
  * fund-service(`本用来做资金的服务`)
  * lottery-service(`彩票`)
  * nativeweb-service
  * platform-service
  * platformManager-service
  * record-service
  * search-service(`ES搜索服务`)
  * sports-service(`体育`)
  * treasure-service
* business-service(`存过改代码`)
* API
  * access2game
  * channelGame
* Font
  * agent(`业主`)
  * agent_api(`业主API`)
  * control
  * manager
  * mobile-server
  * sport(`体育`)
* 其它没有使用jenkins
  * file(`文件服务,git仓库里有`)
  * home-centre 和 jump-server(`推广,域名三级跳`)

