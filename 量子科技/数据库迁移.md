[toc]

## 迁移数据库之前的现状

1. 改游戏存过的代码都是在`prerelease`分支(外侧分支)
2. `Sql Server`里现有`存储过程`,`函数`,`视图`,以及`表`(包括已经没有用的表)

## Mysql集群

mysql使用现有的数据库配置

Mycat配置 `4核 16G`

![image.png](https://i.loli.net/2020/05/14/eZqENJgjfVcXUhS.png)

## 大体流程

`DBA`用`navicat`工具现有数据库中的表和数据,迁移到`mysql`,`开发`修改相关的代码

## 详情

### 开发

1. 先对现有的`prod`分支代码封版,备份
2. 用`prod`新建一个分支,专门用做为迁移`mysql`修改项目里的代码
   1. 在修改代码的时候,有遇到Bug,需要切到`prerelease`分支,并提交构建
3. 需要修改的代码有:
   1. 引入`mybatis-plus`框架
   2. 新建与数据表一一对应的实体类
   3. 修改特性的sql
      1. 把所有的手动分页,都改成使用框架
      2. 把`sql server`特定的sql,转换成mysql
   4. `数据库实体类`中的属性只允许使用4种类型,`Date`,`String`,`Long`,`BigDecimal`
      1. 时间字段格式只保留年月日时分秒
4. `单表`查询都使用框架
5. `多表查询的SQL`写在查询主表的XML里
6. 添加`Druid连接池`,添加`Druid`的监控页面
7. 行记录的插入时间和更新时间,都要手动插入
8. 属性命名都用驼峰写法

### DBA

1. 迁移表结构和数据
2. 在所有的表中添加遗漏的主键
3. 根据业务,添加冗余字段
4. 对所有的查询提供意见,特别是多表查询
5. 数据记录不再自动生成
6. 修改字段,全部小写,单词之间用`_`

### 运维

1. 搭建,维护好`多主多从`,以及`Mysq集群`,和监控工具
2. 映射`Druid`的监控页面
3. 添加mysql性能监控,建议使用`Zabbix`或者`Grafana `
4. DBA提供需要添加监控指标
    ![image.png](https://i.loli.net/2020/05/14/qBlN7mHfIrSDKYx.png)

## 整体测试

### 第一次业务测试

数据库使用现有的表结构和数据

### 第二次业务测试

删除表数据,只是保留基础数据

### 第三次性能测试

导入线上数据到测试环境

不同时间,随机停掉不同数量的`数据库`和`mycat`

## 风险预案

修改config服务的里的所有数据库链接地址,重新构建所有服务有跟数据库交互的服务