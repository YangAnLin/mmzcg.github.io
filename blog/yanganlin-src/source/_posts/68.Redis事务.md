---
title: Redis事务
date: 2020-08-14 00:00:00
categories: Redis
---
![](https://image.yanganlin.com/20200814052359.jpg)
<!-- more --> 
```shell
# 开启事务,设定事务的开启位置，此指令执行后，后续的所有指令均加入到事务中
multi

# 执行提交事务,加入事务的命令暂时到任务队列中，并没有立即执行，只有执行exec命令才开始执行
exec

# 取消事务,终止当前事务定义，发生在multi之后，exec之前
discard
```

## 事务的工作流程

![image-20200813091633178](https://image.yanganlin.com/20200814043756.png)

## 事务的注意事项

- 语法错误
  指命令书写格式有误
- 处理结果
  如果定义的事务中所包含的命令存在语法错误，整体事务中所有命令均不会被执行。包括那些语法正确的命令

----------------------------------------------------------------------------------------------------------------------------------------------------------------

- 运行错误
  指命令格式正确，但是无法正常的执行。例如对list进行incr操作
- 处理结果
  能够正确运行的命令会执行，运行错误的命令不会执行
  注意：已经执行完毕的命令对应的数据不会自动回滚，需要程序员自己在代码中实现回滚。

### 手动进行事务回滚(基本没法用)

- 记录操作过程中被影响的数据之前的状态
  单数据：string
  多数据：hash,list,set,zset
- 设置指令恢复所有的被修改的项
  单数据：直接set（注意周边属性，例如时效）
  多数据：修改对应值或整体克隆复制

## 锁

```shell
# 对key添加监视锁，在执行exec前如果key发生了变化，终止事务执行
watch key1 [key2…]

# 取消对所有key的监视
unwatch
```

## 分布式锁

```shell
# 加锁
setnx lock-key value

# 设置超时时间
expire lock-key second

# 删除锁
dek lock-key
```

- 利用setnx命令的返回值特征，有值则返回设置失败，无值则返回设置成功
- 对于返回设置成功的，拥有控制权，进行下一步的具体业务操作
- 对于返回设置失败的，不具有控制权，排队或等待
  操作完毕通过**del**操作释放锁